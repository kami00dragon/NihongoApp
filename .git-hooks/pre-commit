#!/bin/bash

# Pre-commit security hook for NihongoApp
# This script runs security checks before allowing commits

set -e

echo "ðŸ”’ Running pre-commit security checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function to print colored output
print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

# Check for potential secrets
echo "Checking for potential secrets in committed files..."
if git diff --cached --name-only | xargs grep -l -i "password\|secret\|key\|token\|api_key\|private_key" 2>/dev/null; then
    print_error "Potential secrets found in staged files. Please review and remove."
    exit 1
fi

# Check for executable files that shouldn't be executable
echo "Checking for suspicious executable files..."
if git diff --cached --name-only | xargs file | grep -i "executable" | grep -v ".sh" | grep -v "deploy-secure.sh"; then
    print_warning "Suspicious executable files detected. Please review."
fi

# Check for large files
echo "Checking for large files..."
if git diff --cached --stat | grep -E "^\s*[+-]\s*[0-9]+.*\s+[5-9][0-9]{2,}K"; then
    print_warning "Large files detected. Consider using Git LFS."
fi

# Check for dependency changes
echo "Checking dependency changes..."
if git diff --cached --name-only | grep -E "package\.json|bun\.lock|yarn\.lock|package-lock\.json"; then
    print_warning "Dependencies changed. Make sure to run security audit."
fi

# Ensure no .env files are committed
if git diff --cached --name-only | grep -E "\.env"; then
    print_error ".env files should not be committed. Please remove and add to .gitignore."
    exit 1
fi

# Basic TypeScript/JavaScript syntax check
echo "Running syntax check..."
if git diff --cached --name-only | grep -E "\.(ts|tsx|js|jsx)$" | head -5 | xargs -r npx tsc --noEmit --skipLibCheck 2>/dev/null || true; then
    print_success "Syntax check passed"
else
    print_warning "Syntax check found issues. Please review."
fi

print_success "Pre-commit security checks passed. Commit allowed."