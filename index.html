<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana Español - Funcional y Corregido</title>
    <style>
        :root {
            /* Paleta de Colores: Bandera de Japón (Hinomaru) */
            --bg-paper: #ffffff;     
            --bg-pattern: #f5f5f5;   
            --torii-red: #BC002D;    
            --ink-black: #2c3e50;   
            --theme-color: var(--torii-red);
        }

        /* Reset y Base */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Hiragino Sans', sans-serif; }
        
        body { 
            background-color: var(--bg-paper);
            color: var(--ink-black);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER Y LOGO (SVG TORII) --- */
        header {
            background: white;
            padding: 0.8rem 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom: 4px solid var(--torii-red);
            position: sticky; top: 0; z-index: 100;
        }

        /* Logo SVG */
        .app-logo {
            width: 60px; height: 40px; fill: var(--torii-red); margin-bottom: 0.2rem;
        }

        .header-title { font-size: 1.4rem; color: var(--ink-black); font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        
        .top-controls {
            width: 100%; display: flex; justify-content: space-between; position: absolute; left: 0; top: 0; padding: 10px 15px; box-sizing: border-box; pointer-events: none; 
        }

        .btn-back {
            pointer-events: auto; background: white; color: var(--torii-red); border: 2px solid var(--torii-red);
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: all 0.3s;
        }
        .btn-back:hover { background: var(--torii-red); color: white; }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* --- TARJETAS DE MENÚ (TORII ROJO PERMANENTE) --- */
        .selection-screen { text-align: center; animation: slideUp 0.6s ease-out; width: 100%; display: none; }
        .selection-screen.active { display: block; }

        .mode-card {
            background: white;
            border: 1px solid #eee; position: relative; border-radius: 4px; padding: 0; margin: 1.5rem auto;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 320px;
            overflow: hidden;
            display: inline-block;
            vertical-align: top;
        }

        /* Estructura del Portal Torii (SIEMPRE ROJO PERMANENTE) */
        .mode-card::before {
            /* Dintel Superior */
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 12px; background: var(--torii-red); z-index: 2;
        }
        .mode-card::after {
            /* Dintel Inferior (curva) */
            content: ''; position: absolute; top: 20px; left: 0; width: 100%; height: 6px; background: var(--torii-red); z-index: 2;
        }
        
        .torii-pillars {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            border-left: 10px solid var(--torii-red); /* Pilar Izq - ROJO PERMANENTE */
            border-right: 10px solid var(--torii-red); /* Pilar Der - ROJO PERMANENTE */
            pointer-events: none; 
            z-index: 1;
        }

        .card-content {
            position: relative; 
            z-index: 3; /* Contenido encima de los pilares */
            width: 100%;
            padding: 40px 10px 30px 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            background: white;
            transition: background 0.3s;
        }

        .mode-title { 
            font-size: 1.3rem; font-weight: bold; color: var(--ink-black); margin-bottom: 0.3rem; font-family: serif;
        }
        .mode-desc { font-size: 0.9rem; color: #666; }

        .mode-card:hover { 
            transform: scale(1.03); 
            box-shadow: 0 10px 25px rgba(188, 0, 45, 0.2); 
        }

        /* --- GAME AREA --- */
        #game-screen { display: none; width: 100%; text-align: center; }
        
        .progress-bar {
            font-size: 1rem; color: var(--ink-black); background: #f0f0f0;
            padding: 6px 16px; border-radius: 20px; margin-bottom: 1.5rem; display: inline-block; font-weight: bold; border: 1px solid #ddd;
        }

        .word-context {
            margin-bottom: 2.5rem;
            font-size: 1.8rem;
            color: var(--ink-black);
            font-weight: bold;
            letter-spacing: 2px;
        }

        .syllables-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 2.5rem;
            perspective: 1000px;
            min-height: 100px;
        }

        /* Tarjeta de Aprendizaje */
        .syllable-card {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.7s;
        }

        .whole-word-card {
            width: 280px;
            height: 180px;
        }

        .syllable-card.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-weight: bold;
            user-select: none;
            padding: 10px;
            flex-direction: column;
            border: 1px solid #eee;
        }

        .card-front {
            background-color: white;
            color: var(--ink-black);
            font-size: 1.4rem;
        }

        .card-back {
            background-color: var(--torii-red); /* Dorso ROJO estilo bandera */
            color: white;
            transform: rotateY(180deg);
            border: 1px solid white;
        }
        
        /* Estilos específicos para tarjetas JP -> ES */
        .jp-word-front { font-size: 1.2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .kanji-display { font-size: 2.5rem; margin-bottom: 10px; line-height: 1; font-family: serif; }
        .kana-display { font-size: 1rem; opacity: 0.8; }
        .es-word-back { font-size: 1.6rem; letter-spacing: 1px; }

        /* Controles */
        .controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 2rem;
        }

        .btn {
            background-color: var(--ink-black); 
            color: white; 
            border: none; 
            padding: 15px 30px; font-size: 1rem; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex; align-items: center; gap: 10px; min-width: 130px; justify-content: center;
        }
        .btn:disabled { background-color: #dddddd; color: #999; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background-color: var(--torii-red); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 450px) {
            .syllable-card { width: 80px; height: 80px; font-size: 1.1rem; }
            .whole-word-card { width: 90%; height: 160px; font-size: 2rem; }
            .kanji-display { font-size: 2rem; }
            .mode-card { max-width: 100%; }
        }
    </style>
</head>
<body>

<header>
    <div class="top-controls">
        <button id="btn-reset" class="btn-back" onclick="resetApp()" style="display:none;">← Salir</button>
    </div>
    
    <!-- Logo Torii SVG -->
    <svg class="app-logo" viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
        <!-- Pilar Izquierdo -->
        <rect x="10" y="5" width="8" height="50" fill="#BC002D" rx="1"/>
        <!-- Pilar Derecho -->
        <rect x="82" y="5" width="8" height="50" fill="#BC002D" rx="1"/>
        <!-- Dintel Superior (Curvado) -->
        <path d="M5,10 Q50,-10 95,10 L95,18 Q50,0 5,18 Z" fill="#BC002D"/>
        <!-- Dintel Inferior -->
        <rect x="10" y="22" width="80" height="6" fill="#BC002D"/>
        <!-- Kusabi (Cuñas decorativas) -->
        <rect x="9" y="20" width="4" height="10" fill="#a30027"/>
        <rect x="87" y="20" width="4" height="10" fill="#a30027"/>
    </svg>

    <div class="header-title">Kana Español</div>
    <div id="progress-container" class="progress-bar" style="display:none;">1 / 100</div>
</header>

<main>
    <!-- PANTALLA 1: MENÚ PRINCIPAL -->
    <section id="main-menu" class="selection-screen active">
        <div class="mode-card" onclick="showSubmenu('basic')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Silabario</span>
                <span class="mode-desc">Aprende una a una las sílabas básicas.</span>
            </div>
        </div>

        <div class="mode-card" onclick="showSubmenu('vocab-es')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Vocabulario (Español)</span>
                <span class="mode-desc">Practica con palabras comunes escritas en Kana.</span>
            </div>
        </div>

        <div class="mode-card" onclick="showSubmenu('vocab-jp')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Vocabulario (Japonés)</span>
                <span class="mode-desc">~100 palabras en Kanji y su traducción al español.</span>
            </div>
        </div>

        <div class="mode-card" onclick="showSubmenu('dates')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Fechas</span>
                <span class="mode-desc">Días, meses y días del mes.</span>
            </div>
        </div>

        <div class="mode-card" onclick="showSubmenu('numbers')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Números</span>
                <span class="mode-desc">Del 0 al 1000 y escalas mayores.</span>
            </div>
    </section>

    <!-- PANTALLA 2: SUBMENÚS -->
    <section id="submenu-basic" class="selection-screen">
        <h2 style="margin-bottom: 2rem; color:var(--ink-black);">Elige el modo</h2>
        <div class="mode-card" onclick="startGame('hira', 'basic')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">ひらがな</span>
                <span class="mode-desc">Hiragana</span>
            </div>
        </div>
        <div class="mode-card" onclick="startGame('kata', 'basic')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">カタカナ</span>
                <span class="mode-desc">Katakana</span>
            </div>
    </section>

    <section id="submenu-vocab-es" class="selection-screen">
        <h2 style="margin-bottom: 2rem; color:var(--ink-black);">Elige el modo</h2>
        <div class="mode-card" onclick="startGame('hira', 'vocab-es')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">ひらがな (Hiragana)</span>
                <span class="mode-desc">Hiragana</span>
            </div>
        </div>
        <div class="mode-card" onclick="startGame('kata', 'vocab-es')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">カタカナ (Katakana)</span>
                <span class="mode-desc">Katakana</span>
            </div>
    </section>

    <section id="submenu-vocab-jp" class="selection-screen">
        <h2 style="margin-bottom: 2rem; color:var(--ink-black);">Practicando palabras</h2>
        <div class="mode-card" onclick="startGame('hira', 'vocab-jp')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Comenzar</span>
                <span class="mode-desc">Japonés → Español</span>
            </div>
        </section>

    <section id="submenu-dates" class="selection-screen">
        <h3 style="margin-bottom: 2rem; color:var(--ink-black);">¿Qué quieres practicar?</h3>
        <div class="mode-card" onclick="startGame('hira', 'dates-days')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Días de la semana</span>
            </div>
        </div>
        <div class="mode-card" onclick="startGame('hira', 'dates-months')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Meses del año</span>
            </div>
        </div>
        <div class="mode-card" onclick="startGame('hira', 'dates-ordinal')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Días del mes (1-31)</span>
            </div>
        </div>
    </section>

    <section id="submenu-numbers" class="selection-screen">
        <h3 style="margin-bottom: 2rem; color:var(--ink-black);">¿Qué quieres practicar?</h3>
        <div class="mode-card" onclick="startGame('hira', 'nums-normal')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Números</span>
            </div>
        </div>
        <div class="mode-card" onclick="startGame('hira', 'nums-ordinal')">
            <div class="torii-pillars"></div>
            <div class="card-content">
                <span class="mode-title">Ordinales (1º, 2º...)</span>
            </div>
        </div>
    </section>

    <!-- PANTALLA 3: JUEGO -->
    <section id="game-screen">
        <div id="word-context" class="word-context"></div>
        
        <div id="syllables-area" class="syllables-container">
            <!-- Las tarjetas se generan aquí -->
        </div>

        <div class="controls">
            <button id="btn-prev" class="btn" onclick="prevLesson()">
                <span>← Anterior</span>
            </button>
            <button id="btn-next" class="btn" onclick="nextLesson()">
                <span>Siguiente →</span>
            </button>
        </div>
    </section>
</main>

<script>
    /**
     * DATOS Y LÓGICA
     */

    const kanaDictionary = {
        'a': { hira: 'あ', kata: 'ア' }, 'i': { hira: 'い', kata: 'イ' }, 'u': { hira: 'う', kata: 'ウ' },
        'e': { hira: 'え', kata: 'エ' }, 'o': { hira: 'お', kata: 'オ' },
        'ka': { hira: 'か', kata: 'カ' }, 'ki': { hira: 'き', kata: 'キ' }, 'ku': { hira: 'く', kata: 'ク' },
        'ke': { hira: 'け', kata: 'ケ' }, 'ko': { hira: 'こ', kata: 'コ' },
        'sa': { hira: 'さ', kata: 'サ' }, 'shi': { hira: 'し', kata: 'シ' }, 'su': { hira: 'す', kata: 'ス' },
        'se': { hira: 'せ', kata: 'セ' }, 'so': { hira: 'そ', kata: 'ソ' },
        'ta': { hira: 'た', kata: 'タ' }, 'chi': { hira: 'ち', kata: 'チ' }, 'tsu': { hira: 'つ', kata: 'ツ' },
        'te': { hira: 'て', kata: 'テ' }, 'to': { hira: 'と', kata: 'ト' },
        'na': { hira: 'な', kata: 'ナ' }, 'ni': { hira: 'に', kata: 'ニ' }, 'nu': { hira: 'ぬ', kata: 'ヌ' },
        'ne': { hira: 'ね', kata: 'ネ' }, 'no': { hira: 'の', kata: 'ノ' }, 'n': { hira: 'ん', kata: 'ン' },
        'ha': { hira: 'は', kata: 'ハ' }, 'hi': { hira: 'ひ', kata: 'ヒ' }, 'fu': { hira: 'ふ', kata: 'フ' },
        'he': { hira: 'へ', kata: 'ヘ' }, 'ho': { hira: 'ほ', kata: 'ホ' },
        'ma': { hira: 'ま', kata: 'マ' }, 'mi': { hira: 'み', kata: 'ミ' }, 'mu': { hira: 'む', kata: 'ム' },
        'me': { hira: 'め', kata: 'メ' }, 'mo': { hira: 'も', kata: 'モ' },
        'ya': { hira: 'や', kata: 'ヤ' }, 'yu': { hira: 'ゆ', kata: 'ユ' }, 'yo': { hira: 'よ', kata: 'ヨ' },
        'ra': { hira: 'ら', kata: 'ラ' }, 'ri': { hira: 'り', kata: 'リ' }, 'ru': { hira: 'る', kata: 'ル' },
        're': { hira: 'れ', kata: 'レ' }, 'ro': { hira: 'ろ', kata: 'ロ' },
        'wa': { hira: 'わ', kata: 'ワ' }, 'wo': { hira: 'を', kata: 'ヲ' },
        'ga': { hira: 'が', kata: 'ガ' }, 'gi': { hira: 'ぎ', kata: 'ギ' }, 'gu': { hira: 'ぐ', kata: 'グ' },
        'ge': { hira: 'げ', kata: 'ゲ' }, 'go': { hira: 'ご', kata: 'ゴ' },
        'za': { hira: 'ざ', kata: 'ザ' }, 'ji': { hira: 'じ', kata: 'ジ' }, 'zu': { hira: 'ず', kata: 'ズ' },
        'ze': { hira: 'ぜ', kata: 'ゼ' }, 'zo': { hira: 'ぞ', kata: 'ゾ' },
        'da': { hira: 'だ', kata: 'ダ' }, 'de': { hira: 'で', kata: 'デ' }, 'do': { hira: 'ど', kata: 'ド' },
        'ba': { hira: 'ば', kata: 'バ' }, 'bi': { hira: 'び', kata: 'ビ' }, 'bu': { hira: 'ぶ', kata: 'ブ' },
        'be': { hira: 'べ', kata: 'ベ' }, 'bo': { hira: 'ぼ', kata: 'ボ' },
        'pa': { hira: 'ぱ', kata: 'パ' }, 'pi': { hira: 'ぴ', kata: 'ピ' }, 'pu': { hira: 'ぷ', kata: 'プ' },
        'pe': { hira: 'ぺ', kata: 'ペ' }, 'po': { hira: 'ぽ', kata: 'ポ' },
        'che': { hira: 'ちぇ', kata: 'チェ' },
        'ie': { hira: 'いえ', kata: 'イエ' }
    };

    const curriculumBasic = [
        { romaji: 'a', hira: 'あ', kata: 'ア', word: 'a', breakdown: [{es:'a', romaji:'a'}] },
        { romaji: 'i', hira: 'い', kata: 'イ', word: 'i', breakdown: [{es:'i', romaji:'i'}] },
        { romaji: 'u', hira: 'う', kata: 'ウ', word: 'u', breakdown: [{es:'u', romaji:'u'}] },
        { romaji: 'e', hira: 'え', kata: 'エ', word: 'e', breakdown: [{es:'e', romaji:'e'}] },
        { romaji: 'o', hira: 'お', kata: 'オ', word: 'o', breakdown: [{es:'o', romaji:'o'}] },
        { romaji: 'ka', hira: 'か', kata: 'カ', word: 'ka', breakdown: [{es:'ka', romaji:'ka'}] },
        { romaji: 'ki', hira: 'き', kata: 'キ', word: 'ki', breakdown: [{es:'ki', romaji:'ki'}] },
        { romaji: 'ku', hira: 'く', kata: 'ク', word: 'ku', breakdown: [{es:'ku', romaji:'ku'}] },
        { romaji: 'ke', hira: 'け', kata: 'ケ', word: 'ke', breakdown: [{es:'ke', romaji:'ke'}] },
        { romaji: 'ko', hira: 'こ', kata: 'コ', word: 'ko', breakdown: [{es:'ko', romaji:'ko'}] },
        { romaji: 'sa', hira: 'さ', kata: 'サ', word: 'sa', breakdown: [{es:'sa', romaji:'sa'}] },
        { romaji: 'shi', hira: 'し', kata: 'シ', word: 'shi', breakdown: [{es:'shi', romaji:'shi'}] },
        { romaji: 'su', hira: 'す', kata: 'ス', word: 'su', breakdown: [{es:'su', romaji:'su'}] },
        { romaji: 'se', hira: 'せ', kata: 'セ', word: 'se', breakdown: [{es:'se', romaji:'se'}] },
        { romaji: 'so', hira: 'そ', kata: 'ソ', word: 'so', breakdown: [{es:'so', romaji:'so'}] },
        { romaji: 'ta', hira: 'た', kata: 'タ', word: 'ta', breakdown: [{es:'ta', romaji:'ta'}] },
        { romaji: 'chi', hira: 'ち', kata: 'チ', word: 'chi', breakdown: [{es:'chi', romaji:'chi'}] },
        { romaji: 'tsu', hira: 'つ', kata: 'ツ', word: 'tsu', breakdown: [{es:'tsu', romaji:'tsu'}] },
        { romaji: 'te', hira: 'て', kata: 'テ', word: 'te', breakdown: [{es:'te', romaji:'te'}] },
        { romaji: 'to', hira: 'と', kata: 'ト', word: 'to', breakdown: [{es:'to', romaji:'to'}] },
        { romaji: 'na', hira: 'な', kata: 'ナ', word: 'na', breakdown: [{es:'na', romaji:'na'}] },
        { romaji: 'ni', hira: 'に', kata: 'ニ', word: 'ni', breakdown: [{es:'ni', romaji:'ni'}] },
        { romaji: 'nu', hira: 'ぬ', kata: 'ヌ', word: 'nu', breakdown: [{es:'nu', romaji:'nu'}] },
        { romaji: 'ne', hira: 'ね', kata: 'ネ', word: 'ne', breakdown: [{es:'ne', romaji:'ne'}] },
        { romaji: 'no', hira: 'の', kata: 'ノ', word: 'no', breakdown: [{es:'no', romaji:'no'}] },
        { romaji: 'ha', hira: 'は', kata: 'ハ', word: 'ha', breakdown: [{es:'ha', romaji:'ha'}] },
        { romaji: 'hi', hira: 'ひ', kata: 'ヒ', word: 'hi', breakdown: [{es:'hi', romaji:'hi'}] },
        { romaji: 'fu', hira: 'ふ', kata: 'フ', word: 'fu', breakdown: [{es:'fu', romaji:'fu'}] },
        { romaji: 'he', hira: 'へ', kata: 'ヘ', word: 'he', breakdown: [{es:'he', romaji:'he'}] },
        { romaji: 'ho', hira: 'ほ', kata: 'ホ', word: 'ho', breakdown: [{es:'ho', romaji:'ho'}] },
        { romaji: 'ma', hira: 'ま', kata: 'マ', word: 'ma', breakdown: [{es:'ma', romaji:'ma'}] },
        { romaji: 'mi', hira: 'み', kata: 'ミ', word: 'mi', breakdown: [{es:'mi', romaji:'mi'}] },
        { romaji: 'mu', hira: 'む', kata: 'ム', word: 'mu', breakdown: [{es:'mu', romaji:'mu'}] },
        { romaji: 'me', hira: 'め', kata: 'メ', word: 'me', breakdown: [{es:'me', romaji:'me'}] },
        { romaji: 'mo', hira: 'も', kata: 'モ', word: 'mo', breakdown: [{es:'mo', romaji:'mo'}] },
        { romaji: 'ya', hira: 'や', kata: 'ヤ', word: 'ya', breakdown: [{es:'ya', romaji:'ya'}] },
        { romaji: 'yu', hira: 'ゆ', kata: 'ユ', word: 'yu', breakdown: [{es:'yu', romaji:'yu'}, {es:'go', romaji:'go'}] }, 
        { romaji: 'yo', hira: 'よ', kata: 'ヨ', word: 'yo', breakdown: [{es:'yo', romaji:'yo'}] },
        { romaji: 'ra', hira: 'ら', kata: 'ラ', word: 'ra', breakdown: [{es:'ra', romaji:'ra'}] },
        { romaji: 'ri', hira: 'り', kata: 'リ', word: 'río', breakdown: [{es:'ri', romaji:'ri'}, {es:'o', romaji:'o'}] },
        { romaji: 'ru', hira: 'る', kata: 'ル', word: 'rubio', breakdown: [{es:'ru', romaji:'ru'}, {es:'bi', romaji:'bi'}, {es:'o', romaji:'o'}] },
        { romaji: 're', hira: 'れ', kata: 'レ', word: 're', breakdown: [{es:'re', romaji:'re'}] },
        { romaji: 'ro', hira: 'ろ', kata: 'ロ', word: 'ro', breakdown: [{es:'ro', romaji:'ro'}] },
        { romaji: 'wa', hira: 'わ', kata: 'ワ', word: 'guapo', breakdown: [{es:'wa', romaji:'wa'}, {es:'po', romaji:'po'}] },
        { romaji: 'wo', hira: 'を', kata: 'ヲ', word: 'wo', breakdown: [{es:'wo', romaji:'wo'}] },
        { romaji: 'n', hira: 'ん', kata: 'ン', word: 'en', breakdown: [{es:'en', romaji:'n'}] }
    ];

    function transcribeToKanaBreakdown(word) {
        let s = word.toLowerCase().trim();
        s = s.replace(/ñ/g, 'ny');
        s = s.replace(/lle/g, 're');
        s = s.replace(/ye/g, 'ie');
        s = s.replace(/di/g, 'ri'); s = s.replace(/je/g, 'he'); s = s.replace(/du/g, 'ru');
        s = s.replace(/ll/g, 'y'); s = s.replace(/ch/g, 'ch');
        s = s.replace(/l/g, 'r');
        s = s.replace(/v/g, 'b'); s = s.replace(/x/g, 's');
        s = s.replace(/ca/g, 'ka'); s = s.replace(/co/g, 'ko'); s = s.replace(/cu/g, 'ku');
        s = s.replace(/que/g, 'ke'); s = s.replace(/qui/g, 'ki');
        s = s.replace(/ci/g, 'shi'); s = s.replace(/ce/g, 'se');
        s = s.replace(/si/g, 'shi'); s = s.replace(/z/g, 's');
        s = s.replace(/ja/g, 'ha'); s = s.replace('jo', 'ho'); s = s.replace('ju', 'hu');
        s = s.replace(/ge/g, 'he'); s = s.replace(/gi/g, 'hi');

        let syllables = [];
        let i = 0;
        
        while (i < s.length) {
            let char = s[i];
            let nextChar = s[i+1] || '';
            let nextNextChar = s[i+2] || '';

            if (char === 'c' && nextChar === 'h' && nextNextChar === 'e') {
                 syllables.push({es: 'che', romaji: 'che'});
                 i += 3; continue;
            }
            if (char === 'c' && nextChar === 'h') {
                if (nextNextChar.match(/[aeiou]/)) {
                    let chSyl = 'ch' + nextNextChar;
                    if (chSyl === 'chi') chSyl = 'shi';
                    syllables.push({es: chSyl, romaji: chSyl});
                    i += 3; continue;
                }
                syllables.push({es: 'chi', romaji: 'chi'});
                i += 2; continue;
            }
            if (char === 'n') {
                if (nextChar.match(/[aeiou]/)) {
                    let prevChar = (syllables.length > 0) ? syllables[syllables.length-1].romaji : '';
                    let endsInVowel = (prevChar.length > 0 && prevChar.match(/[aeiou]$/));
                    let afterVowel = s[i+2];
                    if (endsInVowel && afterVowel && afterVowel.match(/[^aeiou]/) && afterVowel !== 'y') {
                        syllables.push({es: 'n', romaji: 'n'});
                        i++; continue;
                    } else {
                        let k = char + nextChar;
                        syllables.push({es: k, romaji: k});
                        i += 2; continue;
                    }
                } else {
                    syllables.push({es: 'n', romaji: 'n'});
                    i++; continue;
                }
            }
            if (char.match(/[aeiou]/)) {
                syllables.push({es: char, romaji: char});
                i++; continue;
            }
            if (char.match(/[^aeiou]/)) {
                if (nextChar.match(/[aeiou]/)) {
                    let k = char + nextChar;
                    syllables.push({es: k, romaji: k});
                    i += 2;
                } else if (nextChar === 'y' && s[i+2] && s[i+2].match(/[aeiou]/)) {
                    let k = char + nextChar + s[i+2];
                    syllables.push({es: k, romaji: k});
                    i += 3;
                } else {
                    if (i + 1 === s.length) {
                        let k = char + 'u';
                        syllables.push({es: k, romaji: k});
                        i++;
                    } else {
                        let k = char + 'u';
                        syllables.push({es: k, romaji: k});
                        i++;
                    }
                }
            }
        }
        return syllables;
    }

    function generateVocabularyES() {
    	let vocabJP = [];

async function loadVocabularyJP() {
    if (vocabJP.length > 0) return vocabJP;

    const response = await fetch('vocab_jp.json');
    const data = await response.json();

    vocabJP = data.map(item => ({
        word: item.es,
        jp: `${item.kanji}<br><span class="kana-text">${item.kana}</span>`,
        displayMode: 'whole'
    }));

    return vocabJP;
}

        const rawWords = ["hola", "adios", "gracias", "agua", "casa", "mundo", "nada", "cada", "solo", "mesa", "silla", "libro", "niño", "niña", "mujer", "hombre", "gato", "perro", "verde", "negro", "blanco", "azul", "rojo", "grande", "pequeño", "amigo", "amiga", "padre", "madre", "hermano", "hermana", "lunes", "martes", "miercoles", "jueves", "viernes", "enero", "febrero", "marzo", "abril", "mayo", "comer", "beber", "dormir", "hablar", "vivir", "trabajar", "estudiar", "coche", "barco", "playa", "mar", "cielo", "sol", "luna", "estrella", "ciudad", "pueblo", "calle", "plaza", "diario", "je", "du", "che"];

        let vocabList = [];
        rawWords.forEach(word => {
            let breakdown = transcribeToKanaBreakdown(word);
            vocabList.push({ word: word, displayMode: 'syllables', breakdown: breakdown });
        });
        return vocabList;
    }

    /**
     * GENERADOR DE NÚMEROS (Lógica Lingüística)
     */
    function formatJapaneseNumber(n) {
        if (n === 0) {
            return { word: "0", jp: "零<br><span class='kana-text'>れい</span>", displayMode: 'whole' }; 
        }

        const digitsKanji = ["", "一", "二", "三", "四", "五", "六", "七", "八", "九"];
        const unitsKanji = ["", "十", "百", "千", "万", "億", "兆"];
        
        const irregularHundreds = { 
            1: "hyaku", 3: "sanbyaku", 6: "roppayaku", 8: "happyaku" 
        };
        const irregularThousands = { 
            1: "sen", 3: "sanzen", 8: "hassen" 
        };
        const digits = ["", "ichi", "ni", "san", "yon", "go", "roku", "nana", "hachi", "kyuu"];
        const units = ["", "juu", "hyaku", "sen", "man", "oku", "chou"];

        let resultKanji = "";
        let resultKana = "";

        // Dividir en grupos de 4 dígitos (sistema base 10,000 japonés)
        let groups = [];
        let temp = n;
        while (temp > 0) {
            groups.push(temp % 10000);
            temp = Math.floor(temp / 10000);
        }

        // Procesar cada grupo
        for (let i = 0; i < groups.length; i++) {
            let g = groups[i];
            if (g === 0) continue;

            let gKanji = "";
            let gKana = "";
            let s = g.toString().padStart(4, '0'); // "0012", "0300", etc.

            // Miles (Posición 0)
            let th = parseInt(s[0]);
            if (th > 0) {
                resultKanji += (th === 1 ? "" : digitsKanji[th]) + "千";
                
                if (th === 3) gKana += "さんぜん";
                else if (th === 8) gKana += "はっせん";
                else resultKana += digits[th] + "せん"; 
            }

           const irregularHundredsKana = {
   		 3: "さんびゃく",
    		 6: "ろっぴゃく",
    		 8: "はっぴゃく"
};

	// Centenas
	let hu = parseInt(s[1]);

	if (hu > 0) {
  	  resultKanji += (hu === 1 ? "" : digitsKanji[hu]) + "百";

	    if (irregularHundredsKana[hu]) {
 	       gKana += irregularHundredsKana[hu];
 	   } else if (hu === 1) {
 	       gKana += "ひゃく";
 	   } else {
  	      gKana += digits[hu] + "ひゃく";
    }
}



            // Decenas (Posición 2)
            let te = parseInt(s[2]);
            if (te > 0) {
                resultKanji += (te === 1 ? "" : digitsKanji[te]) + "十";
                resultKana += digits[te] + "じゅう";
            }

            // Unidades (Posición 3)
            let un = parseInt(s[3]);
            if (un > 0) {
                resultKanji += digitsKanji[un];
                resultKana += digitsKanji[un];
            }
            
            // Unidades de grupo (Man, Oku...)
            if (i > 0) {
                resultKanji += unitsKanji[i];
                let suffix = units[i];
                let prefix = (th > 0) ? digitsKanji[th] : "";
                
                if (suffix === "man") suffix = "まん";
                else if (suffix === "hachiman") suffix = "はっまん";
                else if (suffix === "ichiman") suffix = "いちまん";
                else if (suffix === "ichioku") suffix = "いちまん";
                else if (suffix === "hachioku") suffix = "いちまん";
                else if (suffix === "ichioku") suffix = "いちまん";
                else { if (th === 1) suffix = "いち" + suffix; }
                
                gKana += suffix;
            }

            // Prependear al resultado inverso (los grupos son de menor a mayor)
            resultKanji = gKanji + resultKanji;
            resultKana = gKana + resultKana;
        }

        return {
            word: n.toLocaleString('es-ES'),
            jp: resultKanji + "<br><span class='kana-text'>" + resultKana + "</span>",
            displayMode: 'whole'
        };
    }

    function generateCardinalNumbers() {
        let list = [];
        for (let n = 0; n <= 1000; n++) {
            list.push(formatJapaneseNumber(n));
        }
        list.push(formatJapaneseNumber(10000));
        list.push(formatJapaneseNumber(100000));
        list.push(formatJapaneseNumber(1000000));
        list.push(formatJapaneseNumber(10000000));
        list.push(formatJapaneseNumber(1000000));
        list.push(formatJapaneseNumber(10000000));
        list.push(formatJapaneseNumber(1000000000000));
        list.push(formatJapaneseNumber(10000000000000));
        list.push(formatJapaneseNumber(10000000000000));
        return list;
    }

    /**
     * GENERADOR DE DÍAS DEL MES (1-31)
     */
    function generateDaysOfMonth() {
        const list = [];
        const irregulars = {
            1: "ついたち", 2: "ふつか", 3: "みっか", 4: "よっか", 5: "いつか",
            6: "むいか", 7: "なのか", 8: "ようか", 9: "ここのか", 10: "とおか",
            14: "じゅうよっか", 20: "はつか", 24: "にじゅうよっか"
        };
        const digits = ["", "いち", "に", "さん", "よ", "ご", "ろく", "しち", "はち", "きゅう", "きょ", "なのか", "はち", "きゅう", "きょ"];

        for (let i = 1; i <= 31; i++) {
            let kanji = "", kana = "", label = `Día ${i}`;
            if (irregulars[i]) {
                kana = irregulars[i];
                if (i === 1) kanji = "一日";
                else if (i === 2) kanji = "二日"; else if (i === 3) kanji = "三日"; else if (i === 4) kanji = "四日"; else if (i === 5) kanji = "五日"; 
                else if (i === 6) kanji = "六日"; else if (i === 7) kanji = "七日"; else if (i === 8) kanji = "八日"; else if (i === 9) kanji = "九日"; 
                else if (i === 10) kanji = "十日"; 
                else if (i === 14) kanji = "十四日"; else if (i === 20) kanji = "二十日"; else if (i === 24) kanji = "二十四日";
            } else {
                if (i < 20) { kanji = "十" + digits[i%10] + "日"; kana = "じゅう" + digits[i%10] + "にち"; }
                else if (i < 30) { kanji = "二十" + digits[i%10] + "日"; kana = "にじゅう" + digits[i%10] + "にち"; }
                else { kanji = "三十" + digits[i%10] + "日"; kana = "さんじゅう" + digits[i%10] + "にち";
                }
                if (i === 14) kanji = "十四日"; 
                else if (i === 20) kanji = "二十日"; else if (i === 24) kanji = "二十四日";
            }
            list.push({
                word: label,
                jp: kanji + "<br><span class='kana-text'>" + kana + "</span>",
                displayMode: 'whole'
            });
        }
        return list;
    }

    const dataDates = {
        days: [
            { word: "Lunes", jp: "月曜日<br><span class='kana-text'>げつようび</span>" },
            { word: "Martes", jp: "火曜日<br><span class='kana-text'>かようび</span>" },
            { word: "Miércoles", jp: "水曜日<br><span class='kana-text'>すいようび</span>" },
            { word: "Jueves", jp: "木曜日<br><span class='kana-text'>もくようび</span>" },
            { word: "Viernes", jp: "金曜日<br><span class='kana-text'>きんようび</span>" },
            { word: "Sábado", jp: "土曜日<br><span class='kana-text'>どようび</span>" },
            { word: "Domingo", jp: "日曜日<br><span class='kana-text'>にちようび</span>" }
        ],
        months: [
            { word: "Enero", jp: "一月<br><span class='kana-text'>いちがつ</span>" },
            { word: "Febrero", jp: "二月<br><span class='kana-text'>にがつ</span>" },
            { word: "Marzo", jp: "三月<br><span class='kana-text'>さんがつ</span>" }, 
            { word: "Abril", jp: "四月<br><span class='kana-text'>しがつ</span>" },
            { word: "Mayo", jp: "五月<br><span class='kana-text'>ごがつ</span>" },
            { word: "Junio", jp: "六月<br><span class='kana-text'>ろくがつ</span>" },
            { word: "Julio", jp: "七月<br><span class='kana-text'>しちがつ</span>" }, 
            { word: "Agosto", jp: "八月<br><span class='kana-text'>はちがつ</span>" },
            { word: "Septiembre", jp: "九月<br><span class='kana-text'>くがつ</span>" },
            { word: "Octubre", jp: "十月<br><span class='kana-text'>じゅうがつ</span>" },
            { word: "Noviembre", jp: "十一月<br><span class='kana-text'>じゅういちがつ</span>" },
            { word: "Diciembre", jp: "十二月<br><span class='kana-text'>じゅうにがつ</span>" }
        ],
        ordinal: generateDaysOfMonth()
    };

    /**
     * GENERADOR DE NÚMEROS ORDINALES
     */
    function generateOrdinalNumbers() {
        const list = [];
        
        // 1 - 20 (Lecturas correctas)
        list.push({ word: "1º", jp: "一番目<br><span class='kana-text'>いっちばんめ</span>", displayMode: 'whole' });
        list.push({ word: "2º", jp: "二番目<br><span class='kana-text'>にばんめ</span>", displayMode: 'whole' });
        list.push({ word: "3º", jp: "三番目<br><span class='kana-text'>さんばんめ</span>", displayMode: 'whole' });
        list.push({ word: "4º", jp: "四番目<br><span class='kana-text'>よんばんめ</span>", displayMode: 'whole' });
        list.push({ word: "5º", jp: "五番目<br><span class='kana-text'>ごばんめ</span>", displayMode: 'whole' });
        list.push({ word: "6º", jp: "六番目<br><span class='kana-text'>ろっばんめ</span>", displayMode: 'whole' });
        list.push({ word: "7º", jp: "七番目<br><span class='kana-text'>なのか</span>", displayMode: 'whole' });
        list.push({ word: "8º", jp: "八番目<br><span class='kana-text'>はちばんめ</span>", displayMode: 'whole' });
        list.push({ word: "9º", jp: "九番目<br><span class='kana-text'>ここのか</span>", displayMode: 'whole' });
        list.push({ word: "10º", jp: "十番目<br><span class='kana-text'>じゅうばんめ</span>", displayMode: 'whole' });
        list.push({ word: "11º", jp: "十一番目<br><span class='kana-text'>じゅういちばんめ</span>", displayMode: 'whole' });
        list.push({ word: "14º", jp: "十四目<br><span class='kana-text'>じゅうよっか</span>", displayMode: 'whole' });
        list.push({ word: "20º", jp: "二十日<br><span class='kana-text'>はつか</span>", displayMode: 'whole' }); // 20 -> Hatsuka (Usamos "二十日" como lectura estándar, no nijūnichi)
        list.push({ word: "24º", jp: "二十四日<br><span class='kana-text'>にじゅうよっか</span>", displayMode: 'whole' });
        list.push({ word: "30º", jp: "三十日<br><span class='kana-text'>さんじゅうにち</span>", displayMode: 'whole' }); // San-juu + nichi

        list.push({ word: "100º", jp: "百番目<br><span class='kana-text'>ひゃくばんめ</span>", displayMode: 'whole' });
        list.push({ word: "1000º", jp: "千番目<br><span class='kana-text'>せんばんめ</span>", displayMode: 'whole' });
        list.push({ word: "10000º", jp: "一万番目<br><span class='kana-text'>いちまん</span>", displayMode: 'whole' });
        list.push({ word: "100000", jp: "十万番目<br><span class='kana-text'>じゅうまんめ</span>", displayMode: 'whole' });
        list.push({ word: "1000000", jp: "百万番目<br><span class='kana-text'>ひゃくまんめ</span>", displayMode: 'whole' });

        return list;
    }

    // ESTADO
    let currentMode = null; 
    let currentTrack = null; 
    let currentIndex = 0;
    let currentData = [];
    let isSpecialMode = false; 

    // Referencias DOM
    const mainMenu = document.getElementById('main-menu');
    const submenus = document.querySelectorAll('.selection-screen:not(#main-menu)');
    const gameScreen = document.getElementById('game-screen');
    const syllablesArea = document.getElementById('syllables-area');
    const wordContext = document.getElementById('word-context');
    const progressDisplay = document.getElementById('progress-container');
    const btnNext = document.getElementById('btn-next');
    const btnPrev = document.getElementById('btn-prev');
    const btnReset = document.getElementById('btn-reset');
    const root = document.documentElement;

    function resetApp() {
        gameScreen.style.display = 'none';
        submenus.forEach(el => el.classList.remove('active'));
        mainMenu.classList.add('active');
        progressDisplay.style.display = 'none';
        btnReset.style.display = 'none';
        currentMode = null;
        currentTrack = null;
    }

    function showSubmenu(type) {
        mainMenu.classList.remove('active');
        let id = '';
        if(type === 'basic') id = 'submenu-basic';
        if(type === 'vocab-es') id = 'submenu-vocab-es';
        if(type === 'vocab-jp') id = 'submenu-vocab-jp';
        if(type === 'dates') id = 'submenu-dates';
        if(type === 'numbers') id = 'submenu-numbers';
        document.getElementById(id).classList.add('active');
    }

    function startGame(mode, track) {
        currentMode = mode;
        currentTrack = track;
        currentIndex = 0;
        isSpecialMode = (track.includes('dates') || track.includes('nums'));

        if (isSpecialMode) {
            root.style.setProperty('--theme-color', 'var(--primary-special)');
        } else {
            root.style.setProperty('--theme-color', mode === 'hira' ? 'var(--primary-hiragana)' : 'var(--primary-katakana)');
        }

        if (track === 'basic') {
            currentData = curriculumBasic;
        } else if (track === 'vocab-es') {
            currentData = generateVocabularyES();
        } else if (track === 'vocab-jp') {
    loadVocabularyJP().then(data => {
        currentData = data;
        loadLesson();
    });

    submenus.forEach(el => el.classList.remove('active'));
    gameScreen.style.display = 'block';
    progressDisplay.style.display = 'block';
    btnReset.style.display = 'block';

    return; // ⛔ CRÍTICO
}

}

        } else if (track === 'dates-days') {
            currentData = dataDates.days.map(x => ({...x, displayMode: 'whole'}));
        } else if (track === 'dates-months') {
            currentData = dataDates.months.map(x => ({...x, displayMode: 'whole'}));
        } else if (track === 'dates-ordinal') {
            currentData = dataDates.ordinal.map(x => ({...x, displayMode: 'whole'}));
        } else if (track === 'nums-normal') {
            currentData = generateCardinalNumbers();
        } else if (track === 'nums-ordinal') {
            currentData = generateOrdinalNumbers();
        }

        submenus.forEach(el => el.classList.remove('active'));
        gameScreen.style.display = 'block';
        progressDisplay.style.display = 'block';
        btnReset.style.display = 'block';
        currentData.length;
        loadLesson();
    }

    function loadLesson() {
        const item = currentData[currentIndex];
        
        progressDisplay.textContent = `${currentIndex + 1} / ${currentData.length}`;
        btnPrev.disabled = (currentIndex === 0);
        btnNext.disabled = (currentIndex === currentData.length - 1);

        if (item.displayMode === 'whole') {
            wordContext.textContent = "";
        } else {
            wordContext.textContent = `"${item.word}"`;
        }
        
        syllablesArea.innerHTML = '';

        if (item.displayMode === 'whole') {
            const card = createWholeCard(item);
            syllablesArea.appendChild(card);
        } else {
            item.breakdown.forEach(part => {
                const card = createCard(part);
                syllablesArea.appendChild(card);
            });
        }
    }

    function createCard(part) {
        const card = document.createElement('div');
        card.className = 'syllable-card';
        
        let kanaChar = '?';
        const ref = kanaDictionary[part.romaji];
        if (ref) {
            kanaChar = currentMode === 'hira' ? ref.hira : ref.kata;
        }

        card.innerHTML = `
            <div class="card-face card-front">${part.es}</div>
            <div class="card-face card-back">${kanaChar}</div>
        `;

        card.addEventListener('click', function() {
            if (!this.classList.contains('flipped')) this.classList.add('flipped');
        });
        return card;
    }

    function createWholeCard(item) {
    
        const card = document.createElement('div');
        card.className = 'syllable-card whole-word-card';
        
        card.innerHTML = `
            <div class="card-face card-front">${item.word}</div>
            <div class="card-face card-back">${item.jp}</div>
        `;

        card.addEventListener('click', function() {
            if (!this.classList.contains('flipped')) this.classList.add('flipped');
        });
        return card;
        if (currentTrack === 'vocab-jp') {
    const parts = item.jp.split('<br>');
    const kanji = parts[0] || '';
    const kana = parts[1] || '';

    card.innerHTML = `
        <div class="card-face card-front jp-word-front">
            <div class="kanji-display">${kanji}</div>
            <div class="kana-display">${kana}</div>
        </div>
        <div class="card-face card-back es-word-back">
            ${item.word}
        </div>
    `;
}

    }

    function nextLesson() {
        if (currentIndex < currentData.length - 1) {
            currentIndex++;
            loadLesson();
        }
    }

    function prevLesson() {
        if (currentIndex > 0) {
            currentIndex--;
            loadLesson();
        }
    }

    /* --- FINAL DEL SCRIPT --- */
</script>
</body>
</html>
